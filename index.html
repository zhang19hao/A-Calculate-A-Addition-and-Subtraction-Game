<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å‡æ³•æ¸¸æˆ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>100ä»¥å†…åŠ å‡æ³•æ¸¸æˆ</h1>
            <button class="exit-btn" onclick="exitGame()">
                <span class="icon">ğŸ </span> è¿”å›èœå•
            </button>
        </div>
        <div class="question-display" id="question">ç‚¹å‡»å¼€å§‹ç”Ÿæˆé¢˜ç›®</div>
        <div class="input-group">
            <input type="number" id="answer" placeholder="è¾“å…¥ç­”æ¡ˆ" />
        </div>
        <p class="result" id="result"></p>
        <p id="score">å¾—åˆ†ï¼š0</p>
    </div>

    <script>
        let correctAnswer;
        let score = 0;
        const BASE_URL = 'http://127.0.0.1:5000';
        
        // ä» URL è·å–éš¾åº¦å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const difficulty = urlParams.get('difficulty') || 'medium';

        async function generateQuestion() {
            const questionElement = document.getElementById('question');
            
            try {
                questionElement.innerText = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®...';
                
                const response = await fetch(`${BASE_URL}/generate_question?difficulty=${difficulty}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('è·å–é¢˜ç›®å¤±è´¥');
                }
                
                const data = await response.json();
                correctAnswer = data.answer;
                questionElement.innerText = `${data.question} = ?`;
                document.getElementById('result').innerText = '';
                document.getElementById('answer').value = '';
            } catch (error) {
                questionElement.innerText = 'ç”Ÿæˆé¢˜ç›®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•';
                console.error('é”™è¯¯:', error);
            }
        }

        async function checkAnswer(userAnswer) {
            const resultElement = document.getElementById('result');
            const inputElement = document.getElementById('answer');
            try {
                inputElement.disabled = true;
                
                const response = await fetch(`${BASE_URL}/check_answer`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        answer: userAnswer, 
                        correct_answer: correctAnswer 
                    })
                });
                
                if (!response.ok) {
                    throw new Error('æ£€æŸ¥ç­”æ¡ˆå¤±è´¥');
                }
                
                const result = await response.json();
                if (result.result === 'æ­£ç¡®') {
                    score += 10;
                    resultElement.className = 'result correct';
                    resultElement.innerText = result.result;
                    document.getElementById('score').innerText = `å¾—åˆ†ï¼š${score}`;
                    
                    // ä¿å­˜åˆ†æ•°
                    await saveScore();
                    
                    // ç­”å¯¹åç­‰å¾…1ç§’ç”Ÿæˆæ–°é¢˜ç›®
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    generateQuestion();
                } else {
                    resultElement.className = 'result wrong';
                    resultElement.innerText = result.result;
                    // ç­”é”™åæ¸…ç©ºè¾“å…¥æ¡†ï¼Œå…è®¸ç»§ç»­ç­”é¢˜
                    inputElement.value = '';
                }
            } catch (error) {
                resultElement.innerText = 'æäº¤ç­”æ¡ˆæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•';
                console.error('é”™è¯¯:', error);
            } finally {
                inputElement.disabled = false;
                inputElement.focus(); // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            }
        }

        async function saveScore() {
            try {
                await fetch(`${BASE_URL}/save_score`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        score: score,
                        difficulty: difficulty
                    })
                });
            } catch (error) {
                console.error('ä¿å­˜åˆ†æ•°å¤±è´¥:', error);
            }
        }

        // ç›‘å¬å›è½¦é”®
        document.getElementById('answer').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const userAnswer = parseInt(this.value);
                if (!isNaN(userAnswer)) {
                    checkAnswer(userAnswer);
                    this.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                } else {
                    document.getElementById('result').innerText = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—';
                    document.getElementById('result').className = 'result wrong';
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆç¬¬ä¸€é“é¢˜
        window.onload = generateQuestion;

        async function exitGame() {
            // ä¿å­˜æœ€åçš„åˆ†æ•°
            await saveScore();
            // è¿”å›èœå•é¡µé¢
            window.location.href = 'menu.html';
        }
    </script>
</body>
</html>
